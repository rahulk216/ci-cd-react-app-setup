pipeline {
  agent any

  parameters {
    choice(name: 'ENV', choices: ['development', 'production'], description: 'Deployment Environment')
  }

  environment {
    IMAGE_NAME = "react-app-${params.ENV}"
    CONTAINER_NAME = "react-container-${params.ENV}"
    ENV_PATH = "/var/jenkins_envs/.env.${params.ENV}"
    PORT = params.ENV == 'production' ? "80" : "3000"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Inject Env File') {
      steps {
        sh "cp ${ENV_PATH} .env"
      }
    }

    stage('Build Docker Image') {
      steps {
        sh """
          docker build \
            --build-arg MODE=${params.ENV} \
            -t ${IMAGE_NAME} .
        """
      }
    }

    stage('Deploy Docker Container') {
      steps {
        sh """
          docker stop ${CONTAINER_NAME} || true
          docker rm ${CONTAINER_NAME} || true
          docker run -d --name ${CONTAINER_NAME} -p ${PORT}:80 ${IMAGE_NAME}
        """
      }
    }
  }
}
