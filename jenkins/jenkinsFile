pipeline {
  agent any

  parameters {
    choice(name: 'ENV', choices: ['development', 'production'], description: 'Which environment to deploy to?')
  }

  environment {
    IMAGE_NAME = "my-react-app-${params.ENV}"
    CONTAINER_NAME = "my-react-container-${params.ENV}"
    BUILD_ARG = "${params.ENV}"
    PORT = params.ENV == "development" ? "3000" : "80"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build Docker Image') {
      steps {
        sh "docker build --build-arg MODE=${BUILD_ARG} -t ${IMAGE_NAME} ."
      }
    }

    stage('Deploy') {
      steps {
        script {
          // Stop and remove old container if exists
          sh """
            docker stop ${CONTAINER_NAME} || true
            docker rm ${CONTAINER_NAME} || true
          """

          // Run the container
          sh """
            docker run -d \
              --name ${CONTAINER_NAME} \
              -p ${PORT}:80 \
              ${IMAGE_NAME}
          """
        }
      }
    }
  }
}
